<template>
  <div :class="theme">
    <!-- Alert -->
    <b-alert v-if="alert.details"
            class="alert"
            :show="alert.countdown"
            dismissible
            fade
            :variant="alert.details.type"
            @dismissed="alert.countdown=0"
            @dismiss-count-down="alertCountdownChanged">
      {{alert.details.message}}
    </b-alert>

    <div id="app" v-if="musicKit">
      <!-- Header -->
      <Header />

      <b-container fluid>
        <b-row>
          <b-col lg="3" class="mb-4">
            <b-button :class="{ 'w-100': true, 'd-none': !isAuthorized, 'd-sm-block d-md-block d-lg-none d-xl-none': isAuthorized, 'mb-4': showSidebar }" @click="showSidebar = !showSidebar">
              <i :class="{ 'fa': true, 'fa-bars': !showSidebar, 'fa-times': showSidebar }" /> Menu
            </b-button>
            <Sidebar :class="{ 'd-none': !showSidebar && isAuthorized, 'd-sm-none': !showSidebar && isAuthorized, 'd-md-none': !showSidebar && isAuthorized, 'd-lg-block': true, 'd-xl-block': true }" />
          </b-col>
          <b-col lg="9">
            <router-view></router-view>
          </b-col>
        </b-row>
      </b-container>
    </div>
    <!-- Waiting for MusicKit -->
    <div id="app" v-else>
      <Header>
        <template slot="controls">
          <b-col class="text-center pt-2">
            <i class="fa fa-circle-o-notch fa-spin h2" style="font-size: 20px" aria-hidden="true" />
            <p>Initializing MusicKit JS...</p>
          </b-col>
        </template>
      </Header>

      <b-container fluid>
        <b-row>
          <b-col sm="12">
            <Index />
          </b-col>
        </b-row>
      </b-container>
    </div>

    <b-container fluid>
      <b-row>
        <b-col class="text-muted text-center text-sm mb-4 mt-2">
          <p class="mb-1 pb-0">Copyright &copy; 2018 &mdash; <a href="https://zacharyseguin.ca" target="_blank">Zachary Seguin</a></p>
          <p>Apple and Apple Music are trademarks of Apple Inc., registered in the U.S. and other countries</p>
          <p>
            If you encounter any issues, have any feedback or feature requests,
            please <a href="https://github.com/zachomedia/apple-music-webplayer/issues" target="_blank">submit an issue on GitHub</a>
            or send an email to <a href="mailto:contact@zacharyseguin.ca" target="_blank">contact@zacharyseguin.ca</a>.
          </p>
        </b-col>
      </b-row>
    </b-container>
  </div>
</template>

<script>
import Raven from 'raven-js';
import VueRouter from 'vue-router';

// Import private configuration
import privateConfig from './private';

// Event bus
import EventBus from './event-bus';

// Import custom controls
import Header from './components/Header.vue';
import Index from './views/Index.vue';
import Loading from './components/Loading.vue';
import Sidebar from './components/Sidebar.vue';
import Recommendations from './views/Recommendations.vue';
import SongCollection from './views/SongCollection.vue';
import MyAlbums from './views/MyAlbums.vue';
import MySongs from './views/MySongs.vue';
import MyArtists from './views/MyArtists.vue';
import RecentlyAdded from './views/RecentlyAdded';
import RecentlyPlayed from './views/RecentlyPlayed';
import Artist from './views/Artist.vue';
import Search from './views/Search.vue';
import Me from './views/Me.vue';
import NotFound from './views/NotFound.vue';
import Settings from './views/Settings.vue';
import Debug from './views/Debug.vue';
import Station from './views/Station.vue';

import {formatArtworkURL, formatMillis} from './utils';

// Initialize router
const routes = [
  {
    name: 'index',
    path: '/music',
    component: Index
  },
  {
    name: 'search',
    path: '/music/search',
    component: Search,
    props: {
      title: 'Search'
    },
    meta: {
      title: 'Search'
    }
  },
  {
    name: 'recommendations',
    path: '/music/recommendations',
    component: Recommendations,
    props: {
      title: 'Recommendations'
    },
    meta: {
      title: 'Recommendations',
      isLibrary: true
    }
  },
  {
    name: 'recently-played',
    path: '/music/recently-played',
    component: RecentlyPlayed,
    props: {
      title: 'Recently Played'
    },
    meta: {
      title: 'Recently Played',
      isLibrary: true
    }
  },
  {
    name: 'library',
    path: '/music/library',
    component: Me,
    meta: {
      isLibrary: true
    },
    children: [
      {
        name: 'library-search',
        path: 'search',
        component: Search,
        props: {
          title: 'Search library'
        },
        meta: {
          title: 'Search library',
          isLibrary: true
        }
      },
      {
        name: 'my-songs',
        path: 'songs',
        component: MySongs,
        props: {
          title: 'My songs'
        },
        meta: {
          title: 'My songs',
          isLibrary: true
        }
      },
      {
        name: 'my-albums',
        path: 'albums',
        component: MyAlbums,
        props: {
          title: 'My albums'
        },
        meta: {
          title: 'My albums',
          isLibrary: true
        }
      },
      {
        name: 'library-albums',
        path: 'albums/:id',
        component: SongCollection,
        meta: {
          type: 'album',
          isLibrary: true
        }
      },
      {
        name: 'recently-added',
        path: 'recently-added',
        component: RecentlyAdded,
        props: {
          title: 'Recently Added'
        },
        meta: {
          title: 'Recently Added',
          isLibrary: true
        }
      },
      {
        name: 'library-playlists',
        path: 'playlists/:id',
        component: SongCollection,
        meta: {
          type: 'playlist',
          isLibrary: true
        }
      },
      {
        name: 'my-artists',
        path: 'artists',
        component: MyArtists,
        props: {
          title: 'My artists'
        },
        meta: {
          title: 'My artists',
          isLibrary: true
        }
      },
      {
        name: 'library-artists',
        path: 'artists/:id',
        component: Artist,
        meta: {
          isLibrary: true
        }
      }
    ]
  },
  {
    name: 'playlists',
    path: '/music/playlists/:id',
    component: SongCollection,
    meta: {
      type: 'playlist',
      isLibrary: false
    }
  },
  {
    name: 'albums',
    path: '/music/albums/:id',
    component: SongCollection,
    meta: {
      type: 'album',
      isLibrary: false
    }
  },
  {
    name: 'stations',
    path: '/music/stations/:id',
    component: Station,
    meta: {
      type: 'station',
      isLibrary: false
    }
  },
  {
    name: 'artists',
    path: '/music/artists/:id',
    component: Artist,
    meta: {
      isLibrary: false
    }
  },
  {
    name: 'settings',
    path: '/music/settings',
    component: Settings,
    meta: {
      title: 'Settings',
      isLibrary: false
    },
    props: {
      title: 'Settings'
    }
  },
  {
    name: 'debug',
    path: '/music/debug',
    component: Debug,
    meta: {
      title: 'Debug',
      isLibrary: false
    },
    props: {
      title: 'Debug'
    }
  },
  {
    path: '*',
    component: NotFound,
    meta: {
      title: 'Not found'
    }
  }
];

const router = new VueRouter({
  mode: 'history',
  routes
});

router.beforeEach((to, from, next) => {
  window.scrollTo(0, 0);

  if (to.name === 'library') {
    next({ path: '/music', replace: true });
    return;
  }

  if (to.meta.title) {
    document.title = to.meta.title + ' | Music';
  } else {
    document.title = 'Music';
  }

  try {
    let musicKit = window.MusicKit.getInstance();

    if (to.meta.isLibrary && !musicKit.isAuthorized) {
      next({ path: '/music', replace: true });
      return;
    }
  } catch (err) {
    // Do nothing
  }

  next();
});

export default {
  router,
  name: 'app',
  components: {
    Header,
    Index,
    Loading,
    Sidebar
  },
  localStorage: {
    theme: {
      type: String,
      default: 'light'
    },
    showPlaybackNotifications: {
      type: Boolean,
      default: true
    },
    queueAllSongs: {
      type: Boolean,
      default: true
    },
    bitrate: {
      type: String,
      default: 'STANDARD'
    }
  },
  data: function () {
    return {
      theme: this.$localStorage.get('theme'),
      showSidebar: false,
      isAuthorized: false,

      musicKit: null,
      alert: {
        details: null,
        countdown: 0
      }
    };
  },
  watch: {
    '$route': function () {
      // If the route changes, hide the sidebar
      this.showSidebar = false;
    }
  },
  methods: {
    alertCountdownChanged: function (count) {
      this.alert.countdown = count;
    }
  },
  created: function () {
    this.onThemeChange = () => {
      this.theme = this.$localStorage.get('theme');
      document.body.className = this.theme;
    };
    EventBus.$on('theme', this.onThemeChange);
    this.onThemeChange();

    // Events
    this.onAlert = (alert) => {
      this.alert.details = alert;
      this.alert.countdown = 5;
    };
    EventBus.$on('alert', this.onAlert);

    let initializeMusicKit = () => {
      // Configure MusicKit
      window.MusicKit.configure({
        developerToken: privateConfig.developerToken,
        app: {
          name: 'Music',
          build: '0.1.0'
        },
        bitrate: window.MusicKit.PlaybackBitrate[this.$localStorage.get('bitrate')]
      });

      initialize();
    };

    let initialize = () => {
      let musicKit = window.MusicKit.getInstance();

      if (!musicKit.isAuthorized && this.$route.meta.isLibrary) {
        this.$router.push({ path: '/music', replace: true });
      }

      this.musicKit = musicKit;

      this.isAuthorized = this.musicKit.isAuthorized;
      this.onAuthorizationStatusDidChange = e => {
        this.isAuthorized = this.musicKit.isAuthorized;
      };
      this.musicKit.addEventListener(window.MusicKit.Events.authorizationStatusDidChange, this.onAuthorizationStatusDidChange);

      // Create callback functions
      this.mediaPlaybackError = (event) => {
        Raven.captureException(event);
      };
      this.musicKit.addEventListener(window.MusicKit.Events.mediaPlaybackError, this.mediaPlaybackError);

      this.mediaItemDidChange = (event) => {
        // Show a notification
        if (('Notification' in window) && event.item && this.$localStorage.get('showPlaybackNotifications')) {
          window.Notification.requestPermission();

          if (window.Notification.permission === 'granted') {
            if (this.notification) {
              this.notification.close();
            }

            this.notification = new window.Notification(event.item.attributes.name, {
              tag: 'currentMediaItem',
              body: `${event.item.attributes.artistName} (${formatMillis(event.item.attributes.durationInMillis)})`,
              icon: event.item.attributes.artwork ? formatArtworkURL(event.item.attributes.artwork) : null
            });

            this.notification.onclose = e => {
              this.notification = null;
              clearTimeout(this.notificationTimeout);
            };

            this.notificationTimeout = setTimeout(e => {
              if (this.notification) {
                this.notification.close();
              }
            }, event.item.attributes.durationInMillis);
          }
        }
      };
      this.musicKit.addEventListener(window.MusicKit.Events.mediaItemDidChange, this.mediaItemDidChange);
    };

    // Check for MusicKit
    if (window.MusicKit) {
      try {
        this.musicKit = window.MusicKit.getInstance();
        initialize();
      } catch (err) {
        initializeMusicKit();
      }
    } else {
      document.addEventListener('musickitloaded', () => {
        initializeMusicKit();
      });
    }
  },
  destroyed: function () {
    this.musicKit.removeEventListener(window.MusicKit.Events.authorizationStatusDidChange, this.onAuthorizationStatusDidChange);
    this.musicKit.removeEventListener(window.MusicKit.Events.mediaItemDidChange, this.mediaItemDidChange);

    EventBus.$off('theme', this.onThemeChange);
    EventBus.$off('alert', this.onAlert);
  }
};
</script>

<style>
#app {
  font-size: 0.9rem;
  padding-top: 100px;
}
</style>

<style scoped>
.alert {
  position: fixed !important;
  bottom: 10px;
  right: 10px;
  z-index: 1000;
}

.text-sm {
  font-size: 0.8em;
}
</style>

<style lang="scss">
body {
  font-family: sans-serif;
}

body.light {
  // Default light mode
  @import "assets/_custom.scss";
  @import "~bootstrap/scss/bootstrap.scss";
  @use '~bootstrap-vue/dist/bootstrap-vue';

  background: $body-bg;
  color: $body-color;
}

// Colours for dark mode
body.dark {
  @import "assets/_custom.dark.scss";
  @import "~bootswatch/dist/darkly/variables";
  @import "~bootstrap/scss/bootstrap.scss";
  @use '~bootstrap-vue/dist/bootstrap-vue';

  background: $body-bg;
  color: $body-color;
}

body.modal-open {
  overflow: hidden;

  .modal {
    overflow-x: hidden;
    overflow-y: scroll;
  }
}
</style>
